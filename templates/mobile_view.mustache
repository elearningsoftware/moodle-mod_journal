{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template mod_journal/mobile_view

    This template will render the mobile view.

    Variables required for this template:
    * id - Journal entry record id
    * cmid - Course module id (used for component-id and links)
    * userid - Owner user id
    * timemodified - Time the entry was last modified (formatted)
    * attempt - Attempt number
    * rawscore - Numeric raw score
    * maxscore - Maximum possible score
    * duration - Duration text (e.g. "2 minutes 10 seconds")
    * completionicon - HTML for completion icon
    * successicon - HTML for success icon
    * reporturl - URL/object for report links
    * name - Activity name
    * intro - Activity introduction (HTML)

    Variables optional for this template:
    * user - Optional user object (student)
    * submissions - Array of submission objects (teacher view)
    * studentpic / studentname / studentid / entryid - per-submission fields
    * gradeoptions / rating_minus_one / selected / label - grading select data
    * feedback_plain / feedbacktext - teacher feedback fields
    * teacherpic / teachername / feedbackdate - feedback author info
    * hasentry / hasfeedback / canedit / info - control flags and messages
    * courseid - Course id for navigation

    Example context (json):
    {
      "id": 123,
      "cmid": 456,
      "userid": 789,
      "timemodified": "2026-01-17 12:34",
      "attempt": 1,
      "rawscore": 8.5,
      "maxscore": 10,
      "duration": "2 minutes 10 seconds",
      "completionicon": "<core-icon name=\"checkmark-circle\"></core-icon>",
      "successicon": "<core-icon name=\"thumbs-up\"></core-icon>",
      "reporturl": "https://example.com/report",
      "name": "Journal activity example",
      "intro": "<p>Journal description.</p>",
      "hasentry": true,
      "hasfeedback": true,
      "canedit": true,
      "studentpic": "<img src=\"pic.jpg\"/>",
      "studentname": "Student One",
      "studentid": 789,
      "entryid": 111,
      "text": "<p>Entry text by the student.</p>",
      "feedback_plain": "Well done.",
      "teacherpic": "<img src=\"teacher.jpg\"/>",
      "teachername": "Teacher One",
      "feedbackdate": "2026-01-16",
      "grade": "8.5",
      "feedbacktext": "<p>Positive feedback</p>",
      "courseid": 42,
      "submissions": [
        {
          "studentpic": "<img src=\"pic.jpg\"/>",
          "studentname": "Student One",
          "timemodified": "2026-01-17 12:00",
          "text": "<p>Entry</p>",
          "entryid": 111,
          "studentid": 789,
          "rating_minus_one": "",
          "gradeoptions": [
            { "val": 0, "label": "0" },
            { "val": 10, "label": "10", "selected": "selected" }
          ]
        }
      ]
    }
}}
<div class="ion-padding">
    {{#warning}}
        <core-alert message="{{warning}}" type="warning"></core-alert>
    {{/warning}}

    <ion-card>
        <ion-card-header>
            <ion-card-title>{{name}}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <core-format-text text="{{intro}}" component="mod_journal" component-id="{{cmid}}"></core-format-text>
        </ion-card-content>
    </ion-card>

    <!-- TEACHER VIEW: Grading List -->
    {{#isteacher}}
        <h3>{{#str}}entries, mod_journal{{/str}}</h3>
        {{^submissions}}
            <core-alert message="{{#str}}noentriesmanagers, mod_journal{{/str}}" type="info"></core-alert>
        {{/submissions}}

        <ion-list>
            {{#submissions}}
            <ion-card style="box-shadow: 2px 2px 10px #dedede;">
                <!-- Student Header -->
                <ion-item lines="none">
                    <ion-avatar slot="start">
                        {{{studentpic}}}
                    </ion-avatar>
                    <ion-label>
                        <h2>{{studentname}}</h2>
                        <p>{{timemodified}}</p>
                    </ion-label>
                </ion-item>

                <!-- Student Entry Content -->
                <ion-card-content>
                    <core-format-text text="{{text}}" component="mod_journal" component-id="{{cmid}}"></core-format-text>
                </ion-card-content>

                <hr style="background: var(--ion-card-border-color);">

                <div class="ion-padding">

                    <!--
                         GRADING FORM CONTAINER
                         Using <form ngNoForm> is crucial here.
                         It prevents Angular from throwing "Cannot find control" errors for the inputs inside.
                         It provides a clean DOM scope for the core-site-plugins-call-ws directive to scrape data.
                    -->
                    <form id="journal-feedback-{{entryid}}" ngNoForm>

                        <!-- Required identifiers for the save_feedback Web Service -->
                        <input type="hidden" name="cmid" value="{{cmid}}">
                        <input type="hidden" name="entryid" value="{{entryid}}">
                        <input type="hidden" name="userid" value="{{studentid}}">

                        <!-- Grade Selector -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #666; font-size: 12px; margin-bottom: 5px;">
                                {{#str}}grade, mod_journal{{/str}}
                            </label>
                            <select name="grade"
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; background: white; -webkit-appearance: none;">
                                <option value="-1" {{rating_minus_one}}>{{#str}}nograde, mod_journal{{/str}}</option>
                                {{#gradeoptions}}
                                    <option value="{{val}}" {{selected}}>{{label}}</option>
                                {{/gradeoptions}}
                            </select>
                        </div>

                        <!-- Feedback Editor (Standard Textarea) -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #666; font-size: 12px; margin-bottom: 5px;">
                                {{#str}}feedback, mod_journal{{/str}}
                            </label>

                            <textarea
                                name="feedback"
                                rows="6"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">{{feedback_plain}}</textarea>
                        </div>

                        <!-- itemid required by WS, keep 0 for now -->
                        <input type="hidden" name="itemid" value="0">
                    </form>

                    <div class="ion-margin-top">
                        <!--
                            SAVE BUTTON
                            The directive is placed directly on the ion-button.
                            form="journal-feedback-{{entryid}}" links this button to the form above.
                        -->
                        <ion-button
                            expand="block"
                            core-site-plugins-call-ws
                            name="mod_journal_save_feedback"
                            form="journal-feedback-{{entryid}}"
                            successMessage="{{#str}}changessaved, mod_journal{{/str}}"
                            refreshOnSuccess="true">
                                {{#str}}savefeedback, mod_journal{{/str}}
                        </ion-button>
                    </div>

                </div>
            </ion-card>
            {{/submissions}}
        </ion-list>
    {{/isteacher}}

    <!-- STUDENT VIEW -->
    {{^isteacher}}
        {{#hasentry}}
            <ion-card>
                <ion-item-divider>
                    <ion-label>{{#str}}entry, mod_journal{{/str}}</ion-label>
                </ion-item-divider>
                <ion-card-content>
                    <p><strong>{{#str}}lastedited, mod_journal{{/str}}:</strong> {{lastedited}}</p>
                    <core-format-text text="{{text}}" component="mod_journal" component-id="{{cmid}}"></core-format-text>
                </ion-card-content>
            </ion-card>

            {{#hasfeedback}}
            <ion-card>
                <ion-item-divider>
                    <ion-label>{{#str}}feedback, mod_journal{{/str}}</ion-label>
                </ion-item-divider>
                <ion-item lines="none">
                    <ion-avatar slot="start">
                        {{{teacherpic}}}
                    </ion-avatar>
                    <ion-label>
                        <h2>{{teachername}}</h2>
                        <p>{{feedbackdate}}</p>
                    </ion-label>
                </ion-item>
                <ion-card-content>
                    {{#grade}}<p><strong>{{#str}}grade, mod_journal{{/str}}:</strong> {{grade}}</p>{{/grade}}
                    <hr>
                    <core-format-text text="{{feedbacktext}}" component="mod_journal" component-id="{{cmid}}"></core-format-text>
                </ion-card-content>
            </ion-card>
            {{/hasfeedback}}
        {{/hasentry}}

        {{^hasentry}}
            {{^canedit}}
                <core-alert message="{{#str}}notstarted, mod_journal{{/str}}" type="info"></core-alert>
            {{/canedit}}
        {{/hasentry}}

        <!-- Student edit action: open separate page (no duplicate inline editor/preview) -->
        {{#canedit}}
            <ion-card>
                <ion-item-divider>
                    <ion-label>{{#str}}startoredit, mod_journal{{/str}}</ion-label>
                </ion-item-divider>
                <ion-card-content>
                    {{#info}}<p><i>{{info}}</i></p>{{/info}}

                    <!--
                        NAVIGATE TO EDIT PAGE
                        We use core-site-plugins-new-content to push a new page onto the stack.
                        This calls 'mobile_entry_edit' in mobile.php.
                    -->
                    <ion-button
                        expand="block"
                        core-site-plugins-new-content
                        title="{{#str}}startoredit, mod_journal{{/str}}"
                        component="mod_journal"
                        method="mobile_entry_edit"
                        [args]="{cmid: {{cmid}}, courseid: {{courseid}}}">
                        {{#str}}startoredit, mod_journal{{/str}}
                    </ion-button>
                </ion-card-content>
            </ion-card>
        {{/canedit}}
    {{/isteacher}}
</div>